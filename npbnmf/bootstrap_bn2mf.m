%% Bootstrap BN2MF
% Each script should take a random subsample with replacement, run bn2mf
% Then combine results to create empirical distribution for scores
% Want to compare bootstrap CI to VCI

%% Get job number
j = getenv('SGE_TASK_ID')

%% Choose 1 example of correlated simulations
sim       = table2array(readtable("/ifs/scratch/msph/ehs/eag2186/Data/Corr Ex/corr_sim.csv"));
pre_noise = table2array(readtable("/ifs/scratch/msph/ehs/eag2186/Data/Corr Ex/corr_chem.csv"));
patterns  = table2array(readtable("/ifs/scratch/msph/ehs/eag2186/Data/Corr Ex/corr_patterns.csv"));
scores    = table2array(readtable("/ifs/scratch/msph/ehs/eag2186/Data/Corr Ex/corr_scores.csv"));

%% Normalize truth
patterns_denom      = sum(patterns, 2);
patterns_scaled     = patterns ./ patterns_denom;
patterns_denom_diag = diag(patterns_denom);
scores_scaled       = scores * patterns_denom_diag;

%% Random vector for RNG
rand_vec = [1943390030  746196695   17852396  940589715   42646086 1692962385 1885869580  174393542 1996151257  500383961 1542277254 ...
 2047864733 1801761505  472352621 1901164064  276781489 2144237700 1287261066 1177070671  508867770   54906098 1710116507 ...
   72460519  706288188 2144008053 1522012788  136404331  947831887   63053959  236697809  480539041  900919009 2050901654 ...
 1746339750 1685586903  133255189 1392031761  705707892  545613736 1279444778 1625786061  207200580 1175861432  707538740 ...
  188018141  278412317 1977970720 1341316833 1585172448 1923173550  964272245 1676828299  194795111    1425488  226202817 ...
 1425405539  227303675  400216140  489674218 1883984130 1646108785 1431359662  521739754  759657866  287866418 1330176548 ...
  897105491  580231842  349185096  929438376 2122283525 1509328056  955285452 1654803512 1098486776 1644870105  239994384 ...
 1339596098 1676930598 1216258819  919448435 1462586332 1020334188 1696099450  794891513  640851235 1641996051  314307348 ...
 1950877610  566719717  774764512 1656803790  111177208 1455327775  684682520 1436512824  864953845  308190087 1517416267 ...
1185281157 1501712660 1467789643 1770150923  861787357  214097986  469708646 1073854849 1156464898 1510218641 1181882432 ...
1099721464 1712347023   75546181 1499621278  575026055  382146419  161917915 1958963224  921037478 1559837221  571084051 ...
1418551036 1345522025  606471975 1862399117   61071920 1589846314 1224224471  599542442  377972949 1204660754  358427115 ...
  19039894    3460674  304267629  235973152  265417449  699995583 1851082613 1106646860  210207178  475414714 2028251672 ...
 364459404 1603553743  895170725 1266639975 1721976712  972659317 1993443712  138286195 1923515855 1610277331  484909383 ...
 534156853  856473827  342960225  570658367 1199551482 1348937592  143897698 1381591998  622693109 1865228344 1664994494 ...
1292839847  894930610  406295602 2121557033  132998940  315688677 1248396016 1322290226 1515227450 1043825276 1407196359 ...
  25887967  905670863  123077929  283658629  258065492 1456928663  755829352 1514552522 1677670240  403498628  130712448 ...
   4086749  782435075  440451140  867234854 1607784247  177770726 1820396126 1481140773  283521035 1134047329 1044974153 ...
 972825850 1624231364 1617551318  709097158  167841386 1533006663 1356204371 1951234118 1485491830  246754676  700493856 ...
1231592695  914499124 1978168712  884531831  987283575 2122110258 1387331844  749548042 1369266507  793870574 1141046335 ...
1108362284  364368204 1518207960   45996109  320065656  656042757   17153856  104365820 1154911510 1364751999 2074749936 ...
1990744761  712861413 1699124071  421227520 1371056190 1337811582  638120353  820355897  519629354  206342700  577387133 ...
 565069128 1644755074 1754028876 1019290272  421420773 1318495502 1790808067 1529674676 1134514879 2095921232 2050517859 ...
1615797316 1221938621   31113323  649500762 2056256433  838884651 1155855809 1099149294  192086593 1379855134  356828343 ...
 694143056 1739372957  525060109 1907051109 1434167078  601884580 1854925252  297711293 2044466922 1678745525  635422593 ...
  31450167   80992794 1703797577 1081073711 2138796001 1666000482  864471647  482820424 1401111349 2058678289 1428216814 ...
2088871820  293232071  196367856 2008602100   51134001  801157193  995090587 1046342289   97925406 1988448032  385404052 ...
1034464191 1605407275 1805485625 1872221589  704643529   37078450 1389007322 1704977180 1994637632 1776630316  475589180 ...
 381267903 1313767323 1878359733 1093528260  615235822 1666194843 1112461269  824994680 1505936939 1811737551  538116994 ...
1154541988 1156902452 1766114267  206640916  531480745   23866554   36944306 1639724946 1661395793  889541029 1024954159 ...
 285189409 2002422666 2114446255 1256229000  461872287  668499143 1373780321  257385084  930349764   41071244 1622898923 ...
 560917307  827440286  129957449 2009219160  832070514  797354467 1226917431 1971276740 2035341908  422504097 1768529724 ...
 441348567  612953682  760350133  321527801 1032370574 2131749929  804042399 1223511334 1025447838  341170531 1110154793 ...
 595175031 1626027242  178502317 1613999967 1318511251 1256820111  491383642  858393098 1623218544  825640102 1057485023 ...
1105324082  978023783 1313550639  307704727 1171940067 2088102879 1502616378  306819289 1232822309 2105247878 1980559505 ...
1666281918 1501379163 1239639002  457245573   40760607  344885942 1908748958 1182423882   92173805 1631958171   49355047 ...
1299622191 1404232352  920123854  543212931 1439520632 1664764674 1976579660  130108068 1675231905 1617082218  240143035 ...
 848644910 1948297711 1275815883  846430853 1679729082  147880936 1320929624 1231074419 1152725558  832098226 1136616882 ...
1950899392  363052288 1144180352  571053473 2021302975  738047467 2042946284 2123266043 2139896290  634310233  316558134 ...
1604108887  999328322 1386913308  564713617 1166191049 1091177687  999036925 1684018098 2000122499  654693594 1337438122 ...
1935762400 1945482122  425169746  776171901 1760083454  123316991 1224780405  546677852  260081653 1981630003 1056621324 ...
1339370920 1733473355  467763529  842299824  381211697   15042578  986412443   90048394  145669490  507476510 1068737282 ...
1479690982  412473218 1363038312 2060121849  456796200 1525475000 1717673087  548220924 1224422325  326465434    6475931 ...
  28577250 1127862485 1552942238  146496690 1327471919  807804244  735451657 1187817256 1391905070 2090610061 1744212082 ...
 845371952 1991642467 1142986692 1060603548 2036561178  313094863  725240252  705984902 2043466522  427272827 1462919182 ...
 992434717 1489472389  361008407  248950477 1384535147 1061991465 1655226246  378339068  393141706  371885984 1563294032 ...
1478287970  488549090 1096539040 1210904391  507103316 1238264251  790045978 1782063810 1472528916  305482656 1424597425 ...
1787550698  213943024  844134047  849832670 1029282754  961317998  513092390  479676827  793053350 2107398907  594932651 ...
 716525013 2012272191 1323387714  617945468  864767591 1674641686 1523853845 1814049965  689264523 1576857206 1724281032 ...
1887966172  452770257  895141780  386844976 1209968920 1407972179 1485428181  487894881 1332176620 1554664015 1588428347 ...
 480433277 1622855544  897001510  906698224 2062266298  616077950 1342615590 1925700698  284883502 1312246616 1643810550 ...
1429680712  396470875 1701436772  662298133 1997680974  122364995 1278720906 1402438384 1298250828 1636798609 1528061821 ...
1609905646  399208837 1104968492 1572626096  316020602 1918643174  121153028 1836183086 1441728886  847145319   90328804 ...
 263448924  171471054  820963798 1202642439  272916296  270668448 1521911623 1614545020 1518048680 1268362919 1539695399 ...
 466419114 1001733422 1190717144   85869703  740618196 1500111851  832608700 1156526002  231465637 1419824245 1463720831 ...
 456500646 1297081611  467058610  304127048  757335435 1608617502  117151203 1035731894  850488674  918373094 1946890389 ...
 294523160  877880437 1317803599 1540579419  282134296 1893794839 1621668743 1056565113  356749012 1536072748  676655307 ...
 889235480  230966114  841526788  921179032 1781484361   16414666   84742782 2101109091 1674633209  583274581  191919685 ...
1688093102   12263269 1095087961 1629662988 1493992849 1265427628  804683026  434424900 1958013762 1663627235  843256235 ...
 737586777  272865768  958374694  133414339  762053148 1794664847  677284936 2036263215 1667216606 1316180713 1443009646 ...
 388650792  116354130 1413980968 1975794779  852013341  774017971 1097030591  637451155  685444839 1537171665  459448642 ...
 292892231 2056192888  151825066  952185526  721731784  327050987 1349082798 1097191753  620156889 2023537254  651963776 ...
1962064468 2074591485  722783308 1117860865 1233287719 1832994322  930368622 1660275868 1072104148 1017880380  328681999 ...
 532291651  897914146  677634928 2122727496  523662262 2110764579  372550235 1914376311  803045126 1908727303  908305389 ...
 852723082 1181743506  911368061 1937866366  347352425 1904274259 1583119281 1967645296  552949063 1612760792 1341339609 ...
 514320488 1369358342 1343187338  818457260 2118428684 1606066268 1522039364 1532024241 1518583348 1032720864  847180200 ...
 986027341   24132276  951049936 1783769053  711424975  359996577  798014729  744983611 2095689616  552192927  749832286 ...
1346195959 1533303563  938943374  685432421  884677138 1053511597 1279061803  144696815 1154848212  332228952 1594336004 ...
 762589932  737455620 1908239213  935740004  810320387 1706747728 1428630570  728469760 1172682781 1699077231   83731713 ...
1110857108 2023012852  173378896  858184935 1354472510 1028555446 1489928845 1054539546 2016995322  526298820   11514366 ...
 415100753  789294869  244320403  369983800 1562871850 1910542769 1059440565  368072684  922225402 1899857198 2079333191 ...
1364007198  667586905   36999540  848721056 1214073035  643189732  528194115  920445303 1894915217  313636919  996906276 ...
 418272797  269686340  789508743 1253026383 1665568133 2088939179 1198844693  105700405 1895675579 1032516148 1483849538 ...
1057973266 2105142549 1079919705  750314642 2022198124 1661653392 1238954525 1276208842 1942737878 2144220240  171775517 ...
1836359963  936194779 1519236157  787469585  832919006  420215944  581928316 1902749730 1985259737   85332766  131213599 ...
1036974107 1957322852 1294643416 2067337156  609014270 1616261500  514434213  534518691 1322619928 1622420041  784696911 ...
1479414688 1075637747  853138137 1151667224 1621607129   31859427 1609106288  351860878 1461172972  258768882 1698503816 ...
 632338487 1286733560 1902623134  358166561 1094066432 1906881905    3228876  865229623  170659190 1195415964 2125502650 ...
 935445971  942651635  614827058  396632817  162079772  974309838 2056463613  520026529   80261232 1925582454  531161745 ...
  71236500   74820485 1834007411  104367396 1721627265  107454957  429554288 1740536824 1527825948 1572894409  416173224 ...
 630656637 1035113147 1172027835 1569228002 1068825526 1651435801 1773055491 2134330912  390129666 1306623467 1201107679 ...
 945967294 1238706013 1700030512 1457364389  833006152 1648469563  106390356  220218158 1773296758 1194419426  379465641 ...
 318219205  869646436 1830482956  170224419 1581833842 1220506244  179572560  729806113 1827303861 2073044174  920043659 ...
2061548962 1304006203  814881495 1235018464 1121571862 1733707933 1716726394  667799820   93734756  703560089 1239684484 ...
1123940413 1373165328  903205574 1720162487 1630761728 1329133519  983569745 1042389820 2131257436  603396849  901146566 ...
2033447433 1399998961 1743554598   21428809  346214299 2135883406 1145680931 1232308793  110156241  839803448 1898023863 ...
1155840119  246675851  274858690 1130114630  742469502 1584064989 1373247843  794912590 1966002673 1786725098  657089579 ...
 449390853  153269017  754811593  130706218 1032979431 1305634633  487411021 1270963355 2045866343 1210456763  345339559 ...
1612442925  441068886 1604793150 1225315556  642218549 1620090257 1657185784 1314498135  213066046 1515535052 1365945003 ...
1216192668  530381776  616742052  796971407 1828416709  646830756 2117706347 1499954538 1995034731  136569494 1038745986 ...
 475390737  872117561 2040247960  846795023 1694367100 1752983857  200033734 2056062082 1216830147  877103602];

rng(rand_vec(str2num(j)))
init_seed_struct = rng; % bc default is seed = 0
randn(1000); % Warming up the mersenne twister rng

%% Take a bootstrapped sample
[n, p] = size(sim);
sam = randsample(1:n, n, true);
sim_sample = sim(sam, :);

%% Run bn2mf
[EWA0, EH0, varH0, alphaH0, betaH0, alphaW0, betaW0, ...
   alphaA0, betaA0, varWA0, finalscore0, final_iter0, init] = BN2MF(sim_sample);

pred = EWA0 * EH0;

%% Normalize EH to L1 norm across chemicals
H_denom   = sum(EH0, 2);
EH_scaled = EH0 ./ H_denom;

%% Scale EWA by corresponding normalization constant
H_denom_diag = diag(H_denom);
EWA_scaled   = EWA0 * H_denom_diag;

%% Rearrange solution to match truth
[~,Pi] = factor_correspondence(patterns_scaled',EH_scaled');
EH_final = (EH_scaled' * Pi)';
EWA_final = EWA_scaled * Pi;

save(strcat("/ifs/scratch/msph/ehs/eag2186/npbnmf/bootstrap_cor/bs_ewa_", num2str(j), ".mat"), 'EWA_final');
save(strcat("/ifs/scratch/msph/ehs/eag2186/npbnmf/bootstrap_cor/bs_eh_",  num2str(j), ".mat"), 'EH_final');
